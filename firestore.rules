rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOperator() {
        return request.auth != null; 
    }

    // ==========================================================
    // ATURAN KOLEKSI ABSENSI (CEK DUPLIKASI)
    // ==========================================================
    match /absensi/{absensiId} {

      allow read: if isOperator(); 
      allow update, delete: if false; 

      // ATURAN CREATE (PENYIMPANAN BARU)
      allow create: if isOperator()
                    && request.resource.data.user_id is int 
                    && request.resource.data.qr_id is int 
                    // Memastikan ID dokumen sesuai format: "QR_ID_USER_ID"
                    && request.resource.data.qr_id.toString() + "_" + request.resource.data.user_id.toString() == absensiId
                    // PENTING: CEK DUPLIKASI
                    && !exists(/databases/$(database)/documents/absensi/$(absensiId));
    }

    // ==========================================================
    // ATURAN KOLEKSI USERS
    // ==========================================================
    match /users/{userId} {
        // Izinkan Operator/Admin membaca semua data user
        allow read: if isOperator(); 
        // Izinkan user menulis/mengupdate data mereka sendiri (saat registrasi/update profil)
        allow write: if request.auth.uid == userId; 
    }

    // ==========================================================
    // ATURAN KOLEKSI PENGAJUAN SAKIT (BARU DITAMBAHKAN)
    // ==========================================================
    match /pengajuan_sakit/{pengajuanId} {
        // Izinkan user yang login untuk membaca pengajuan mereka sendiri
        allow read: if request.auth != null && request.auth.uid == resource.data.userId;
        
        // Izinkan user yang login untuk membuat pengajuan baru (create)
        allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
        
        // Izinkan user yang login untuk mengupdate atau menghapus pengajuan mereka sendiri
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /pengajuan_izin/{pengajuanId} {
        // Izinkan user yang login untuk membaca pengajuan mereka sendiri
        allow read: if request.auth != null && request.auth.uid == resource.data.userId;
        
        // Izinkan user yang login untuk membuat pengajuan baru (create)
        allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
        
        // Izinkan user yang login untuk mengupdate atau menghapus pengajuan mereka sendiri
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}